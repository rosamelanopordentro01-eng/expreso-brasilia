<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados de Viajes - Expreso Brasilia</title>
    <link rel="stylesheet" href="css/results.css">
</head>
<body>

    <!-- HEADER -->
    <header class="search-header">
        <button class="search-header__back" id="backBtn">
            <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </button>

        <!-- Logo envuelto en c√≠rculo blanco como el original -->
        <div class="search-header__logo-wrapper">
            <img class="search-header__logo"
                 src="https://reservamos-platform-prod.s3.us-west-2.amazonaws.com/logos/brasilia/isotype.png"
                 alt="Brasilia">
        </div>

        <!-- Bot√≥n con texto + icono de lupa como el original -->
        <button class="search-header__change-btn" id="changeSearchBtn">
            <span>Cambiar b√∫squeda</span>
            <span class="search-header__change-btn-icon">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </span>
        </button>

        <!-- User con c√≠rculo como el original -->
        <button class="search-header__user">
            <span class="search-header__user-circle">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </span>
        </button>
    </header>

    <!-- FILTROS -->
    <div class="filter-bar">
        <button class="filter-bar__filters-btn">
            <span class="filter-bar__icon-box">
                <svg viewBox="0 0 16 14" width="14" height="12">
                    <path fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round"
                        d="M1 3h14M4 7h8M6 11h4"/>
                </svg>
            </span>
            <span class="filter-bar__filters-text">Filtros</span>
            <span class="filter-bar__badge" id="filterCount">0</span>
        </button>
        <button class="filter-bar__nav-prev">
            <svg width="10" height="18" viewBox="0 0 10 18">
                <path d="M9 1L1 9l8 8" fill="none" stroke="#9B9B9B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <div class="filter-bar__tags-scroll">
            <button class="filter-bar__time-btn" data-filter="morning">Ma√±ana</button>
            <button class="filter-bar__time-btn" data-filter="afternoon">Tarde</button>
            <button class="filter-bar__time-btn" data-filter="night">Noche</button>
            <button class="filter-bar__time-btn" data-filter="dawn">Madrugada</button>
        </div>
        <button class="filter-bar__nav-next">
            <svg width="10" height="18" viewBox="0 0 10 18">
                <path d="M1 1l8 8-8 8" fill="none" stroke="#9B9B9B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <main>
        <!-- Loading -->
        <div class="results-loading" id="loadingState">
            <div class="results-loading__spinner"></div>
            <p class="results-loading__text">Buscando los mejores viajes...</p>
        </div>

        <!-- Resultados -->
        <div id="resultsContent" style="display: none;">
            <!-- Titulo -->
            <div class="results-title">
                <h1 class="results-title__heading">Seleccionar horario de ida</h1>
                <p class="results-title__date" id="routeDate">-</p>
            </div>

            <!-- Viajes Recomendados -->
            <section class="recommended-section" id="recommendedSection" style="display: none;">
                <div class="recommended-section__header">
                    <h2 class="recommended-section__title">Viajes recomendados</h2>
                    <div class="badge-para-ti-container">
                        <div class="badge-para-ti-stars badge-para-ti-stars--left">
                            <div class="badge-para-ti-stars__anim">
                                <div>
                                    <svg width="100%" viewBox="0 0 17 12" xmlns="http://www.w3.org/2000/svg">
                                        <title>stars</title>
                                        <defs>
                                            <linearGradient x1="0%" y1="50%" x2="100%" y2="50%" id="starsGradientLeft">
                                                <stop stop-color="#002674" offset="0%"></stop>
                                                <stop stop-color="#002674" offset="100%"></stop>
                                            </linearGradient>
                                        </defs>
                                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <g transform="translate(2, 2)" fill="url(#starsGradientLeft)" fill-rule="nonzero">
                                                <path d="M3.028,1.31 C3.06,1.209 3.15,1.14 3.251,1.14 C3.352,1.14 3.442,1.209 3.474,1.31 L3.893,2.639 C4.081,3.231 4.521,3.695 5.082,3.892 L6.341,4.335 C6.437,4.368 6.502,4.463 6.502,4.57 C6.502,4.677 6.437,4.772 6.341,4.806 L5.082,5.248 C4.521,5.445 4.08,5.91 3.893,6.502 L3.474,7.83 C3.442,7.931 3.352,8 3.251,8 C3.15,8 3.06,7.931 3.028,7.83 L2.609,6.502 C2.422,5.91 1.981,5.445 1.42,5.248 L0.161,4.806 C0.065,4.772 0,4.677 0,4.57 C0,4.463 0.065,4.368 0.161,4.335 L1.42,3.892 C1.981,3.695 2.422,3.231 2.609,2.639 L3.028,1.31 Z"></path>
                                                <path d="M10.686,0.111 C10.708,0.045 10.768,0 10.835,0 C10.902,0 10.961,0.045 10.983,0.111 L11.263,0.996 C11.387,1.392 11.681,1.701 12.056,1.833 L12.894,2.128 C12.958,2.151 13,2.214 13,2.284 C13,2.355 12.958,2.418 12.894,2.441 L12.056,2.736 C11.681,2.867 11.387,3.177 11.263,3.572 L10.983,4.457 C10.961,4.524 10.902,4.568 10.835,4.568 C10.768,4.568 10.708,4.524 10.686,4.457 L10.407,3.572 C10.282,3.177 9.988,2.867 9.614,2.736 L8.776,2.441 C8.713,2.418 8.671,2.355 8.671,2.284 C8.671,2.214 8.713,2.151 8.776,2.128 L9.614,1.833 C9.988,1.701 10.282,1.391 10.407,0.996 L10.686,0.111 Z"></path>
                                            </g>
                                        </g>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <span class="badge-para-ti-text">PARA TI</span>
                        <div class="badge-para-ti-stars badge-para-ti-stars--right">
                            <div class="badge-para-ti-stars__anim">
                                <div>
                                    <svg width="100%" viewBox="0 0 17 12" xmlns="http://www.w3.org/2000/svg">
                                        <title>stars</title>
                                        <defs>
                                            <linearGradient x1="0%" y1="50%" x2="100%" y2="50%" id="starsGradientRight">
                                                <stop stop-color="#002674" offset="0%"></stop>
                                                <stop stop-color="#002674" offset="100%"></stop>
                                            </linearGradient>
                                        </defs>
                                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <g transform="translate(2, 2)" fill="url(#starsGradientRight)" fill-rule="nonzero">
                                                <path d="M3.028,1.31 C3.06,1.209 3.15,1.14 3.251,1.14 C3.352,1.14 3.442,1.209 3.474,1.31 L3.893,2.639 C4.081,3.231 4.521,3.695 5.082,3.892 L6.341,4.335 C6.437,4.368 6.502,4.463 6.502,4.57 C6.502,4.677 6.437,4.772 6.341,4.806 L5.082,5.248 C4.521,5.445 4.08,5.91 3.893,6.502 L3.474,7.83 C3.442,7.931 3.352,8 3.251,8 C3.15,8 3.06,7.931 3.028,7.83 L2.609,6.502 C2.422,5.91 1.981,5.445 1.42,5.248 L0.161,4.806 C0.065,4.772 0,4.677 0,4.57 C0,4.463 0.065,4.368 0.161,4.335 L1.42,3.892 C1.981,3.695 2.422,3.231 2.609,2.639 L3.028,1.31 Z"></path>
                                                <path d="M10.686,0.111 C10.708,0.045 10.768,0 10.835,0 C10.902,0 10.961,0.045 10.983,0.111 L11.263,0.996 C11.387,1.392 11.681,1.701 12.056,1.833 L12.894,2.128 C12.958,2.151 13,2.214 13,2.284 C13,2.355 12.958,2.418 12.894,2.441 L12.056,2.736 C11.681,2.867 11.387,3.177 11.263,3.572 L10.983,4.457 C10.961,4.524 10.902,4.568 10.835,4.568 C10.768,4.568 10.708,4.524 10.686,4.457 L10.407,3.572 C10.282,3.177 9.988,2.867 9.614,2.736 L8.776,2.441 C8.713,2.418 8.671,2.355 8.671,2.284 C8.671,2.214 8.713,2.151 8.776,2.128 L9.614,1.833 C9.988,1.701 10.282,1.391 10.407,0.996 L10.686,0.111 Z"></path>
                                            </g>
                                        </g>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="recommendedTrips"></div>
            </section>

            <!-- Todos los viajes -->
            <div class="results-container">
                <div class="results-list" id="tripsList"></div>
            </div>

            <!-- Footer -->
            <footer class="search-footer">
                <div class="search-footer__powered">
                    <span>Powered by</span>
                    <span class="search-footer__logo">Reserhub</span>
                </div>
                <p class="search-footer__message">Mostrando todos los viajes disponibles</p>
            </footer>
        </div>

        <!-- Estado vacio -->
        <div class="results-empty" id="emptyState" style="display: none;">
            <div class="results-empty__icon">üöå</div>
            <h2 class="results-empty__title">No encontramos viajes</h2>
            <p class="results-empty__message">No hay viajes disponibles para esta ruta y fecha.</p>
            <button class="results-empty__btn" id="newSearchBtn">Nueva busqueda</button>
        </div>

        <!-- Estado error -->
        <div class="results-empty" id="errorState" style="display: none;">
            <div class="results-empty__icon">‚ö†Ô∏è</div>
            <h2 class="results-empty__title">Error de conexion</h2>
            <p class="results-empty__message" id="errorMessage">No se pudo conectar.</p>
            <button class="results-empty__btn" id="retryBtn">Reintentar</button>
        </div>
    </main>

    <!-- BARRA DE FECHAS FIJA HORIZONTAL -->
    <div class="date-bar" id="dateBar">
        <button class="date-bar__nav" id="datePrev">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
        </button>
        <div class="date-bar__dates" id="dateButtons"></div>
        <button class="date-bar__nav" id="dateNext">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
            </svg>
        </button>
    </div>

    <!-- PANEL DE SILLAS (BOTTOM SHEET) -->
    <div class="seats-overlay" id="seatsOverlay">
        <div class="seats-panel">
            <div class="seats-panel__header">
                <h2 class="seats-panel__title">Elige tus sillas de ida</h2>
                <button class="seats-panel__close" id="seatsClose">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6l12 12" stroke="#BF0811" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="seats-panel__trip-info" id="seatsTripInfo"></div>
            <div class="seats-panel__body">
                <div class="seats-legend" id="seatsLegend"></div>
                <div class="seats-map" id="seatsMap"></div>
            </div>
            <div class="seats-panel__footer">
                <div class="seats-panel__footer-info">
                    <span class="seats-panel__footer-label">Precio aproximado*</span>
                    <span class="seats-panel__footer-price" id="seatsPrice">Elige al menos 1 silla</span>
                </div>
                <button class="seats-panel__footer-details" id="seatsDetailsBtn">Ver detalles</button>
                <button class="seats-panel__footer-btn" id="seatsContinueBtn" disabled>Elige al menos 1 silla</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const origin = urlParams.get('origin') || '';
        const destination = urlParams.get('destination') || '';
        const date = urlParams.get('date') || new Date().toISOString().split('T')[0];

        let allTrips = [];

        const shortMonths = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];

        function formatPrice(price) {
            return new Intl.NumberFormat('es-CO').format(price);
        }

        // 1. Formato fecha: "28-Ene-26"
        function formatDisplayDate(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const day = String(d.getDate()).padStart(2, '0');
            const month = shortMonths[d.getMonth()];
            const year = String(d.getFullYear()).slice(-2);
            return `${day}-${month}-${year}`;
        }

        // Formato fecha barra inferior: "27 Ene"
        function formatBarDate(d) {
            return `${d.getDate()} ${shortMonths[d.getMonth()]}`;
        }

        function parseTime(timeStr) {
            const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return 0;
            let hour = parseInt(match[1]);
            const mins = parseInt(match[2]);
            if (match[3].toUpperCase() === 'PM' && hour !== 12) hour += 12;
            if (match[3].toUpperCase() === 'AM' && hour === 12) hour = 0;
            return hour;
        }

        // Parseo con minutos para ordenar correctamente
        function parseTimeMinutes(timeStr) {
            const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return 0;
            let hour = parseInt(match[1]);
            const mins = parseInt(match[2]);
            if (match[3].toUpperCase() === 'PM' && hour !== 12) hour += 12;
            if (match[3].toUpperCase() === 'AM' && hour === 12) hour = 0;
            return hour * 60 + mins;
        }

        // Parsear duraci√≥n tipo "7h 49min" a minutos totales
        function parseDuration(durStr) {
            var hours = 0, mins = 0;
            var hMatch = durStr.match(/(\d+)h/);
            var mMatch = durStr.match(/(\d+)min/);
            if (hMatch) hours = parseInt(hMatch[1]);
            if (mMatch) mins = parseInt(mMatch[1]);
            return hours * 60 + mins;
        }

        function getTimeSlotIcon(timeStr) {
            const hour = parseTime(timeStr);
            // Madrugada (0-5) y Noche (18-23): √≠cono de nube/luna
            // Ma√±ana (6-11) y Tarde (12-17): √≠cono de sol
            if (hour >= 6 && hour < 18) {
                // Sol con rayos (ma√±ana/tarde)
                return '<svg width="15" height="15" viewBox="0 0 26 19" xmlns="http://www.w3.org/2000/svg"><g stroke="none" fill="none" fill-rule="evenodd"><g fill="#000" fill-rule="nonzero"><path d="M21,14L19.78,14C19.78,10.306 16.963,7.301 13.5,7.301C10.037,7.301 7.22,10.306 7.22,14L6,14C6,9.589 9.365,6 13.5,6C17.635,6 21,9.588 21,14Z"/><rect x="13" y="0" width="1" height="5"/><polygon transform="translate(5.432,5.181) rotate(45) translate(-5.432,-5.181)" points="3.144 4.564 7.719 4.564 7.719 5.799 3.144 5.799"/><polygon transform="translate(20.614,5.181) rotate(45) translate(-20.614,-5.181)" points="19.996 2.894 21.232 2.894 21.232 7.468 19.996 7.468"/><rect x="21" y="12" width="5" height="1"/><rect x="0" y="12" width="5" height="1"/><rect x="6" y="15" width="15" height="1"/><rect x="6" y="18" width="15" height="1"/></g></g></svg>';
            } else {
                // Nube/luna (madrugada/noche)
                return '<svg width="15" height="15" viewBox="0 0 29 23" xmlns="http://www.w3.org/2000/svg"><g stroke="none" fill="none" fill-rule="evenodd"><g fill="#000" fill-rule="nonzero"><path d="M28.1,5.908C26.759,6.1 25.345,5.691 24.31,4.671C23.292,3.639 22.883,2.233 23.075,0.897C23.119,0.592 23.194,0.292 23.301,0C22.977,0.025 22.656,0.08 22.34,0.163C21.459,0.396 20.626,0.851 19.936,1.538C19.186,2.286 18.711,3.202 18.5,4.166C17.257,3.614 15.897,3.318 14.49,3.318C10.262,3.318 6.459,6.069 5.128,10.047C2.277,10.18 0,12.534 0,15.409C0,18.369 2.414,20.777 5.383,20.777C6.173,20.777 6.958,20.602 7.669,20.269C9.515,22.032 11.924,23 14.489,23C18.627,23 22.294,20.446 23.732,16.607C23.821,16.617 23.908,16.622 23.994,16.622C25.453,16.622 26.641,15.438 26.641,13.983C26.641,13.443 26.471,12.918 26.158,12.474C26.475,11.907 26.641,11.269 26.641,10.613C26.641,10.321 26.605,10.038 26.542,9.764C26.867,9.559 27.174,9.319 27.457,9.037C28.147,8.35 28.603,7.519 28.836,6.641C28.92,6.325 28.975,6.005 29,5.682C28.707,5.789 28.406,5.864 28.1,5.908ZM25.305,12.799C25.606,13.129 25.771,13.55 25.771,13.983C25.771,14.96 24.974,15.755 23.994,15.755C23.861,15.755 23.721,15.735 23.553,15.692L23.16,15.592L23.033,15.977C21.812,19.659 18.379,22.133 14.489,22.133C12.053,22.133 9.77,21.176 8.063,19.438L7.832,19.203L7.543,19.361C6.884,19.72 6.137,19.91 5.382,19.91C2.894,19.91 0.869,17.891 0.869,15.41C0.869,12.928 2.893,10.909 5.38,10.909L5.771,10.912L5.863,10.602C6.988,6.825 10.535,4.186 14.489,4.186C15.862,4.186 17.187,4.493 18.384,5.067C18.682,5.21 18.972,5.369 19.253,5.545C20.122,6.088 20.904,6.784 21.561,7.615L21.74,7.841L22.018,7.765C22.282,7.692 22.547,7.656 22.804,7.656C23.986,7.656 25.005,8.35 25.482,9.348C25.606,9.609 25.693,9.891 25.736,10.186C25.757,10.326 25.771,10.468 25.771,10.614C25.771,11.205 25.596,11.777 25.266,12.265L25.076,12.547L25.305,12.799ZM26.843,8.424C26.654,8.612 26.452,8.775 26.241,8.922C25.614,7.66 24.311,6.788 22.805,6.788C22.562,6.788 22.316,6.813 22.07,6.862C21.284,5.921 20.346,5.151 19.308,4.57C19.456,3.684 19.868,2.834 20.551,2.152C21.026,1.678 21.584,1.339 22.176,1.122C22.061,2.603 22.56,4.123 23.677,5.264L23.675,5.266C23.682,5.272 23.688,5.278 23.695,5.284C23.704,5.292 23.71,5.301 23.719,5.31L23.721,5.307C24.865,6.422 26.39,6.918 27.875,6.804C27.658,7.396 27.317,7.951 26.843,8.424Z"/></g></g></svg>';
            }
        }

        function createTripCard(trip, index, isRecommended = false) {
            const isHighlighted = isRecommended && index === 0;
            const hasDiscount = true;
            const cardClass = isHighlighted ? 'trip-card trip-card--highlighted' : 'trip-card';

            // Badge popular
            const hasBadge = trip.badges && trip.badges.includes('popular');
            const badgeHTML = hasBadge ? `<span class="trip-card__badge-popular">Popular</span>` : '';

            // Logo din√°mico
            const lineLogoUrl = trip.lineLogoUrl || 'https://reservamos-platform-prod.s3.us-west-2.amazonaws.com/uploads/line/logo/12/PREMIUM_PLUS.jpg';

            const cardInner = `
                <article class="${cardClass} fade-in">
                    <div class="trip-card__content">
                        ${!isHighlighted ? badgeHTML : ''}
                        <div class="trip-card__header">
                            <div class="trip-card__line-info">
                                <img
                                    src="${lineLogoUrl}"
                                    alt="${trip.serviceName}"
                                    class="trip-card__line-logo"
                                    onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='inline';"
                                >
                                <span class="trip-card__line-name-fallback" style="display:none;">${trip.serviceName}</span>
                                <div class="trip-card__service">
                                    <span class="trip-card__service-name">${trip.serviceName}</span>
                                    <span class="trip-card__service-type">Preferencial de Lujo</span>
                                </div>
                            </div>
                            <div class="trip-card__price-container">
                                <div class="trip-card__price-old">Anterior: <span class="trip-card__price-striked">$ ${formatPrice(trip.price.original || trip.price.current)}</span> COP</div>
                                <div class="trip-card__price">
                                    <span class="trip-card__price-amount">$ ${formatPrice(trip.price.current)}</span>
                                    <span class="trip-card__price-currency">COP</span>
                                </div>
                            </div>
                        </div>

                        <div class="trip-card__schedule">
                            <div class="trip-card__departure">
                                <div class="trip-card__time-row">
                                    <span class="trip-card__time-icon">${getTimeSlotIcon(trip.departure.time)}</span>
                                    <span class="trip-card__time">${trip.departure.time}</span>
                                </div>
                                <span class="trip-card__terminal">${trip.departure.terminal}</span>
                            </div>
                            <div class="trip-card__schedule-connector">
                                <span class="trip-card__duration-line"></span>
                            </div>
                            <div class="trip-card__arrival">
                                <span class="trip-card__time">${trip.arrival.time}</span>
                                <span class="trip-card__terminal">${trip.arrival.terminal}</span>
                            </div>
                            <span class="trip-card__routes">1 ruta</span>
                        </div>

                        <div class="trip-card__actions">
                            <button class="trip-card__details-btn">Ver detalles</button>
                            <button class="trip-card__seats-btn" data-trip-id="${trip.id}">Ver sillas</button>
                        </div>
                    </div>
                </article>
            `;

            // Envolver card destacada en wrapper ‚Äî estilo seg√∫n badges
            if (isHighlighted) {
                const hasRecommended = trip.badges && trip.badges.includes('recommended');
                const wrapperClass = hasRecommended
                    ? 'trip-card-highlighted-wrapper--fastest'
                    : 'trip-card-highlighted-wrapper--popular';
                const icon = hasRecommended ? 'üöÄ' : 'üî•';
                const labelText = hasRecommended ? 'M√°s r√°pido' : 'Popular';

                return `<div class="trip-card-highlighted-wrapper ${wrapperClass}">
                            <div class="trip-card__side-label">
                                <span class="trip-card__highlight-icon">${icon}</span>
                                <span class="trip-card__side-label-text">${labelText}</span>
                            </div>
                            ${cardInner}
                        </div>`;
            }
            return cardInner;
        }

        function showResults(data) {
            document.getElementById('loadingState').style.display = 'none';

            if (!data.trips || data.trips.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            allTrips = data.trips;
            document.getElementById('resultsContent').style.display = 'block';

            // 1. Actualizar fecha formato "28-Ene-26"
            document.getElementById('routeDate').textContent = formatDisplayDate(data.date);

            // Ordenar viajes cronol√≥gicamente por hora de salida (hora + minutos)
            allTrips.sort(function(a, b) {
                return parseTimeMinutes(a.departure.time) - parseTimeMinutes(b.departure.time);
            });

            // Elegir el viaje recomendado:
            // Si alguno tiene badge "recommended" ‚Üí el m√°s r√°pido entre los recommended
            // Si ninguno tiene "recommended" ‚Üí el m√°s r√°pido de todos
            var hasAnyRecommended = allTrips.some(function(t) {
                return t.badges && t.badges.includes('recommended');
            });

            var recommendedTrip;
            if (hasAnyRecommended) {
                var recommendedOnes = allTrips.filter(function(t) {
                    return t.badges && t.badges.includes('recommended');
                });
                recommendedTrip = recommendedOnes.reduce(function(best, trip) {
                    var bestDur = parseDuration(best.duration);
                    var tripDur = parseDuration(trip.duration);
                    return tripDur < bestDur ? trip : best;
                }, recommendedOnes[0]);
            } else {
                recommendedTrip = allTrips.reduce(function(best, trip) {
                    var bestDur = parseDuration(best.duration);
                    var tripDur = parseDuration(trip.duration);
                    return tripDur < bestDur ? trip : best;
                }, allTrips[0]);
            }

            // Viajes recomendados
            if (allTrips.length > 0) {
                document.getElementById('recommendedSection').style.display = 'block';
                document.getElementById('recommendedTrips').innerHTML =
                    createTripCard(recommendedTrip, 0, true);
            }

            // Resto de viajes (excluir el recomendado)
            var restTrips = allTrips.filter(function(t) { return t !== recommendedTrip; });
            renderTrips(restTrips);

            // Barra de fechas
            const minPrice = Math.min(...allTrips.map(t => t.price.current));
            generateDateBar(data.date, minPrice);
        }

        function renderTrips(trips) {
            document.getElementById('tripsList').innerHTML = trips.map((t, i) => createTripCard(t, i + 1, false)).join('');
        }

        // 7. Filtros: madrugada + ma√±ana
        function filterByTime(filter) {
            let filtered = [...allTrips];
            if (filter === 'dawn') {
                filtered = allTrips.filter(t => { const h = parseTime(t.departure.time); return h >= 0 && h < 6; });
            } else if (filter === 'morning') {
                filtered = allTrips.filter(t => { const h = parseTime(t.departure.time); return h >= 6 && h < 12; });
            } else if (filter === 'afternoon') {
                filtered = allTrips.filter(t => { const h = parseTime(t.departure.time); return h >= 12 && h < 18; });
            } else if (filter === 'night') {
                filtered = allTrips.filter(t => { const h = parseTime(t.departure.time); return h >= 18 && h < 24; });
            }

            if (filtered.length > 0) {
                var fastestFiltered = filtered.reduce(function(best, trip) {
                    var bestDur = parseDuration(best.duration);
                    var tripDur = parseDuration(trip.duration);
                    return tripDur < bestDur ? trip : best;
                }, filtered[0]);
                document.getElementById('recommendedSection').style.display = 'block';
                document.getElementById('recommendedTrips').innerHTML = createTripCard(fastestFiltered, 0, true);
                renderTrips(filtered);
            } else {
                document.getElementById('recommendedSection').style.display = 'none';
                document.getElementById('tripsList').innerHTML = '<div class="results-empty" style="display:block"><div class="results-empty__icon">üöå</div><h2 class="results-empty__title">Sin viajes en este horario</h2><p class="results-empty__message">No hay viajes disponibles en este rango.</p></div>';
            }
        }

        // 8. Barra de fechas: solo d√≠as adyacentes, formato "27 Ene"
        function generateDateBar(currentDate, minPrice) {
            const dateButtons = document.getElementById('dateButtons');
            const current = new Date(currentDate + 'T00:00:00');
            let html = '';

            [-1, 1].forEach(offset => {
                const d = new Date(current);
                d.setDate(d.getDate() + offset);
                const dateStr = d.toISOString().split('T')[0];
                const dayStr = formatBarDate(d);

                html += `
                    <div class="date-bar__item" data-date="${dateStr}">
                        <span class="date-bar__day">${dayStr}</span>
                        <span class="date-bar__price">Desde: <strong>$${formatPrice(minPrice)}</strong> COP</span>
                    </div>
                `;
            });

            dateButtons.innerHTML = html;

            dateButtons.querySelectorAll('.date-bar__item').forEach(item => {
                item.addEventListener('click', () => {
                    const newDate = item.dataset.date;
                    window.location.href = `/results.html?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&date=${newDate}`;
                });
            });
        }

        async function searchTrips() {
            if (!origin || !destination) {
                window.location.href = '/';
                return;
            }

            try {
                const params = new URLSearchParams({ origin, destination, date });
                const response = await fetch(`${API_BASE_URL}/search?${params}`);
                const data = await response.json();

                if (data.success) {
                    showResults(data);
                } else {
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('errorMessage').textContent = data.error || 'Error';
                    document.getElementById('errorState').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorMessage').textContent = 'Error de conexion';
                document.getElementById('errorState').style.display = 'block';
            }
        }

        // Event listeners
        document.getElementById('backBtn').addEventListener('click', () => window.location.href = '/');
        document.getElementById('changeSearchBtn').addEventListener('click', () => window.location.href = '/');
        document.getElementById('newSearchBtn').addEventListener('click', () => window.location.href = '/');
        document.getElementById('retryBtn').addEventListener('click', () => searchTrips());

        // 7. Filtros de tiempo
        document.querySelectorAll('.filter-bar__time-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Si ya est√° activo, deseleccionar (mostrar todos)
                if (btn.classList.contains('active')) {
                    btn.classList.remove('active');
                    renderTrips(allTrips);
                    return;
                }
                document.querySelectorAll('.filter-bar__time-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                filterByTime(btn.dataset.filter);
            });
        });

        // Init
        searchTrips();

        // ============================================
        // PANEL DE SILLAS
        // ============================================

        const personSVG = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="rgb(155,155,155)"/></svg>';
        const steeringWheelSVG = '<svg width="25" height="25" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9.5" stroke="#9B9B9B" stroke-width="1.5" fill="none"/><circle cx="12" cy="12" r="3" stroke="#9B9B9B" stroke-width="1.5" fill="none"/><line x1="12" y1="2.5" x2="12" y2="9" stroke="#9B9B9B" stroke-width="1.5"/><line x1="3.5" y1="16" x2="9.4" y2="13.5" stroke="#9B9B9B" stroke-width="1.5"/><line x1="20.5" y1="16" x2="14.6" y2="13.5" stroke="#9B9B9B" stroke-width="1.5"/></svg>';

        let currentSeats = [];
        let currentTripPrice = 0;
        let currentTrip = null;
        const TOTAL_BUS_SEATS = 42; // 10 filas x 4 + √∫ltima fila x 2 = 42

        function generateMockSeats(freeCount) {
            const seats = [];
            const available = Math.max(0, Math.min(freeCount, TOTAL_BUS_SEATS));
            const occupied = TOTAL_BUS_SEATS - available;
            // Asientos libres al final del bus
            for (let i = 1; i <= TOTAL_BUS_SEATS; i++) {
                seats.push({
                    number: i,
                    status: i <= occupied ? 'occupied' : 'free'
                });
            }
            return seats;
        }

        function renderLegend() {
            const free = currentSeats.filter(s => s.status === 'free').length;
            const selected = currentSeats.filter(s => s.status === 'selected').length;
            const occupied = currentSeats.filter(s => s.status === 'occupied').length;

            const freeLabel = free === 1 ? 'Libre' : 'Libres';
            const selectedLabel = selected === 1 ? 'Elegido' : 'Elegidos';
            const occupiedLabel = occupied === 1 ? 'Ocupado' : 'Ocupados';

            document.getElementById('seatsLegend').innerHTML = `
                <div class="seats-legend__item">
                    <div class="seats-legend__box seats-legend__box--free"></div>
                    <span class="seats-legend__count">${free}</span>
                    <span class="seats-legend__label">${freeLabel}</span>
                </div>
                <div class="seats-legend__item">
                    <div class="seats-legend__box seats-legend__box--selected"></div>
                    <span class="seats-legend__count">${selected}</span>
                    <span class="seats-legend__label">${selectedLabel}</span>
                </div>
                <div class="seats-legend__item">
                    <div class="seats-legend__box seats-legend__box--occupied">${personSVG.replace('width="20" height="20"', 'width="14" height="14"')}</div>
                    <span class="seats-legend__count">${occupied}</span>
                    <span class="seats-legend__label">${occupiedLabel}</span>
                </div>
            `;
        }

        function renderSeatBtn(seat) {
            if (!seat) {
                return '<button class="seat-btn seat-btn--empty" disabled></button>';
            }
            if (seat.status === 'occupied') {
                return `<button class="seat-btn seat-btn--occupied" disabled>${personSVG}</button>`;
            }
            if (seat.status === 'selected') {
                return `<button class="seat-btn seat-btn--selected" data-seat="${seat.number}">${seat.number}</button>`;
            }
            return `<button class="seat-btn seat-btn--free" data-seat="${seat.number}">${seat.number}</button>`;
        }

        function renderBusMap() {
            const rows = [];
            const seatsPerRow = 4;
            // 11 filas: 10 filas de 4 asientos + 1 fila de 2 asientos = 42
            const totalFullRows = 10;
            const totalRows = 11;

            for (let r = 0; r < totalRows; r++) {
                const startIdx = r * seatsPerRow;

                // √öltima fila (fila 11): solo 2 asientos en el lado izquierdo
                if (r === totalRows - 1) {
                    const left1 = currentSeats[totalFullRows * seatsPerRow] || null;
                    const left2 = currentSeats[totalFullRows * seatsPerRow + 1] || null;
                    rows.push(`
                        <div class="seats-row">
                            <div class="seats-row__left">${renderSeatBtn(left1)}${renderSeatBtn(left2)}</div>
                            <div class="seats-row__aisle"></div>
                            <div class="seats-row__right">${renderSeatBtn(null)}${renderSeatBtn(null)}</div>
                        </div>
                    `);
                } else {
                    const left1 = currentSeats[startIdx] || null;
                    const left2 = currentSeats[startIdx + 1] || null;
                    const right1 = currentSeats[startIdx + 2] || null;
                    const right2 = currentSeats[startIdx + 3] || null;
                    rows.push(`
                        <div class="seats-row">
                            <div class="seats-row__left">${renderSeatBtn(left1)}${renderSeatBtn(left2)}</div>
                            <div class="seats-row__aisle"></div>
                            <div class="seats-row__right">${renderSeatBtn(right1)}${renderSeatBtn(right2)}</div>
                        </div>
                    `);
                }
            }

            document.getElementById('seatsMap').innerHTML = `
                <div class="seats-map__type">Autob√∫s de un piso</div>
                <div class="seats-bus">
                    <div class="seats-bus__front">${steeringWheelSVG}</div>
                    <div class="seats-grid">${rows.join('')}</div>
                </div>
            `;
        }

        function updateFooter() {
            const selected = currentSeats.filter(s => s.status === 'selected').length;
            const priceEl = document.getElementById('seatsPrice');
            const btnEl = document.getElementById('seatsContinueBtn');

            if (selected === 0) {
                priceEl.textContent = 'Elige al menos 1 silla';
                btnEl.textContent = 'Elige al menos 1 silla';
                btnEl.disabled = true;
            } else {
                const total = selected * currentTripPrice;
                priceEl.textContent = `$ ${formatPrice(total)} COP`;
                const sillaText = selected === 1 ? '1 silla' : `${selected} sillas`;
                btnEl.textContent = `Continuar con ${sillaText}`;
                btnEl.disabled = false;
            }
        }

        function handleSeatClick(e) {
            const btn = e.target.closest('[data-seat]');
            if (!btn) return;
            const seatNum = parseInt(btn.dataset.seat);
            const seat = currentSeats.find(s => s.number === seatNum);
            if (!seat) return;

            if (seat.status === 'free') {
                seat.status = 'selected';
            } else if (seat.status === 'selected') {
                seat.status = 'free';
            }

            renderBusMap();
            renderLegend();
            updateFooter();
        }

        function openSeatsPanel(trip) {
            const fullMonths = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
            const depDate = new Date(trip.departure.date + 'T00:00:00');
            const dateStr = depDate.getDate() + ' ' + fullMonths[depDate.getMonth()];

            document.getElementById('seatsTripInfo').innerHTML = `
                <span class="seats-panel__trip-departure">${trip.departure.time}</span>
                <div class="seats-panel__trip-connector">
                    <span class="seats-panel__trip-routes">1 ruta</span>
                    <span class="seats-panel__trip-line"></span>
                </div>
                <span class="seats-panel__trip-arrival">${trip.arrival.time}</span>
                <span class="seats-panel__trip-date">${dateStr}</span>
            `;

            currentTrip = trip;
            currentTripPrice = trip.price.current;
            currentSeats = generateMockSeats(trip.availableSeats || 8);

            renderLegend();
            renderBusMap();
            updateFooter();

            // Usar delegaci√≥n de eventos una sola vez
            document.getElementById('seatsMap').onclick = handleSeatClick;

            const overlay = document.getElementById('seatsOverlay');
            overlay.style.display = 'block';
            document.body.classList.add('seats-open');
            requestAnimationFrame(() => {
                overlay.classList.add('seats-overlay--visible');
            });
        }

        function closeSeatsPanel() {
            const overlay = document.getElementById('seatsOverlay');
            overlay.classList.remove('seats-overlay--visible');
            document.body.classList.remove('seats-open');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 350);
        }

        // Cerrar con bot√≥n X
        document.getElementById('seatsClose').addEventListener('click', closeSeatsPanel);

        // Cerrar al hacer clic en el overlay (fuera del panel)
        document.getElementById('seatsOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeSeatsPanel();
        });

        // Delegaci√≥n de eventos para botones "Ver sillas" (se crean din√°micamente)
        document.addEventListener('click', function(e) {
            const seatsBtn = e.target.closest('.trip-card__seats-btn');
            if (!seatsBtn) return;
            const tripId = seatsBtn.dataset.tripId;
            const trip = allTrips.find(t => t.id === tripId);
            if (trip) openSeatsPanel(trip);
        });

        // Bot√≥n "Continuar con X sillas" ‚Üí guardar datos y navegar a passengers.html
        document.getElementById('seatsContinueBtn').addEventListener('click', function() {
            if (this.disabled || !currentTrip) return;
            const selectedSeats = currentSeats
                .filter(s => s.status === 'selected')
                .map(s => s.number);
            const tripData = {
                tripId: currentTrip.id,
                serviceName: currentTrip.serviceName,
                serviceType: currentTrip.serviceType,
                departureTime: currentTrip.departure.time,
                arrivalTime: currentTrip.arrival.time,
                departureTerminal: currentTrip.departure.terminal,
                arrivalTerminal: currentTrip.arrival.terminal,
                departureCity: currentTrip.departure.city,
                arrivalCity: currentTrip.arrival.city,
                date: currentTrip.departure.date,
                duration: currentTrip.duration,
                selectedSeats: selectedSeats,
                pricePerSeat: currentTripPrice,
                totalPrice: selectedSeats.length * currentTripPrice,
                origin: origin,
                destination: destination
            };
            localStorage.setItem('tripData', JSON.stringify(tripData));
            window.location.href = '/passengers.html';
        });
    </script>
</body>
</html>
